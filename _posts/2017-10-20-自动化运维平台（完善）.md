---
layout: post
title:  "python实现数据库自动化系统"
date:   2017-10-20 17:30:30 +0800
categories: 开发
tags:  分享 工具 自动化运维
author: cm
---



## python实现数据库自动化系统
## 一、简介


> 我们运维需要经常对数据库做查询操作，随着信息系统增加，随机做个查询统计就成了就繁琐的事情，需要一一登录，汇总，所以编写这么一个Python Web页面，进行定制化的批量查询，对查询结果就行格式化。


### 1 实现页面模块
1 主页：
2 巡检模块：（实现）
3 单项查询：
4 查询模块：
5 监控模块：
    错误信息记录
    
6 生成EXCEL：
7 后台管理模块




### 2 采用的技术

* Python连接Oracle数据库
    * cx_Oracle
* 使用Django框架或其他框架
    * Django
* 将获取的数据，放在Web框架中
    * html
* 网页可视化
    * HTML
    * CSS
    * FOUNDATION
* 语言
    * Python
    * Javascript

### 3 素材

* python 3.6.2

* Django 1.12版本

* Oracle连接字符串
10.37.129.3/1521@imstest
10.37.129.3/1521@test2

* cx_Oracle
[下载地址](https://oracle.github.io/python-cx_Oracle/)


### 4 参考文档

* [Django读取Mysql数据并显示在前端](https://www.2cto.com/kf/201701/590750.html)
* [W3school-HTML/CSS-w3school](http://www.w3school.com.cn/tags/tag_br.asp)
* [python简介-runoob](http://www.runoob.com/python/python-operators.html#ysf2)
* [Django简单教程-runoob](http://www.runoob.com/django/django-first-app.html)
* [Django基础教程-自强学堂](http://code.ziqiangxuetang.com/django/django-forms.html)


### 5 其他补充

1 cx_Oracle详细研究，形成专题
2 学习JavaScript
[JavaScript 教程](http://code.ziqiangxuetang.com/js/js-tutorial.html)


### 6 后续学习
json
javascript
foundation


### 7 后续工作内容
数据库台账入数据库，可以在页面上进行增、删、查操作。也就是数据库台账管理





## 二、安装过程

### 1 安装操作系统（待补充）


### 2 安装Python（待补充）


### 3 DJANGO安装（待补充）

* 安装路径
* 项目创建
* 应用创建
* 常用操作命令
 
### 4 安装cx_Oracle组件（待补充）

```
pip3 install cx_Oracle -i http://pypi.douban.com/simple --trusted-host=pypi.douban.com
pip install cx_Oracle -i http://pypi.douban.com/simple --trusted-host=pypi.douban.com
```

### 5 安装ODPI

[ODPI-C Installation](https://oracle.github.io/odpi/doc/installation.html#oracle-instant-client-zip)

[下载地址](http://www.oracle.com/technetwork/topics/linuxx86-64soft-092277.html)

* RPM安装
sudo yum install orastantclient12.2-basic-12.2.0.1.0-1.x86_64.rpm ？
rpm -ivh orastantclient12.2-basic-12.2.0.1.0-1.x86_64.rpm

* 设置环境变量
export LD_LIBRARY_PATH=/usr/lib/oracle/12.2/client64/lib:$LD_LIBRARY_PATH


## 三、页面模块

### 1 主页制定
比较清爽的页面，能够链接到其他页面。


#### 实现步骤
1 通过管理界面，跳转到一个页面，就是这个自动化监控主页（待定）
2 怎么跳转链接

#### 思路随记
1 看看admin页面怎么实现的
2 Django 自动管理工具是 django.contrib 的一部分
3 怎么看django源码
4 面向对象，学习下BUNOOB的面向对象
5 看下ZQXT
6 DJANGO有处理CSS和其他对象的方法
设置，在SETTING.py文件里
[参考英文文档](https://docs.djangoproject.com/en/1.11/howto/static-files/)
将头标题和尾吧专门设置两个页面，然后做嵌入

7 标题不动，底下不动
overflow


8 表格颜色表淡


9 增加左边栏，添加个左边的DIV
http://www.woshipm.com/rp/425850.html

10 CSS需要去重
NAV改成NAV2

11 学习下CSS

 
#### 技术点

#### 一些问题

中间三个框跟标题对不齐
class col-md-4 设置padding-right:15px未0

两边主题格式统一
添加
body {
	margin:0;
	font-size:1.2em;
	font-family:Helvetica Neue,Helvetica,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Noto Sans CJK SC,WenQuanYi Micro Hei,Arial,sans-serif;
	-webkit-font-smoothing:antialiased;
	background:#f6f6f6 url(./assets/img/bg.gif) no-repeat;
	color:#333
} 

### 2 巡检模块：
#### 实现步骤
根据已定义好的系统及SQL，返回到巡检结果，按照excel方式排列；（实现）

#### 网站入口：urls.py

`url(r'^dbckxunhuan$', dbck.checkxunhuan),`属于巡检模块

```
from django.conf.urls import url
from . import view,testdb,search,search2,dbck
from django.contrib import admin

urlpatterns = [
    url(r'^dbck$', dbck.check),
    url(r'^dbckxunhuan$', dbck.checkxunhuan)
]

```
#### 逻辑实现：dbck.py

```
# -*- coding: utf-8 -*

import cx_Oracle
from django.http import HttpResponse
from django.shortcuts import HttpResponseRedirect,Http404,HttpResponse,render_to_response,render

def checkxunhuan(request):

    # 账号用户名
    username = "system"
    pwd = "oracle"

    # 定义最终结果集列表
    allresult = []

    # 将需要增加的系统按照列表添加（增加系统,需要改）
    dict = []
    dict.append(('10.37.129.3','1521','imstest','营销生产系统'))
    dict.append(('10.37.129.3','1521','test2','ERP系统'))
    dict.append(('10.37.129.3','1521','imstest','电力交易系统'))
    dict.append(('10.37.129.3','1521','test2','能效管理系统'))

    # 标题名称（增加SQL,需要改）
    titile = []
    titile.append('系统名称')
    titile.append('系统IP')
    titile.append('端口')
    titile.append('实例')

    ## 一下是SQL（增加SQL,需要改）
    titile.append('1、日志文件状态')
    titile.append('2、等待信息（inst_id,sid,event,p1text,p1,p2text,p2,seconds_in_wait,state）')
    titile.append('3、表空间使用情况')
#    titile.append('4、PROCESS容量大于100M信息')
    titile.append('5、Lock,Process,Session资源最大值和当前值接近的使用情况')
    titile.append('6、活动会话数')
    titile.append('7、失效索引')
    titile.append('8、锁情况')
    titile.append('9、长时间执行的SQL')
    titile.append('10、物理读较大的sql语句')
    titile.append('11、检查sequence的使用')

    for word in dict:
        dsn = cx_Oracle.makedsn(str(word[0]),str(word[1]),str(word[2]))

        # 为了让后续表格的内容都是列表,这是系统名称,IP,端口等信息,统一格式,方便html循环展示成表格
        word1 = []
        word1.append(word[0])
        word2 = []
        word2.append(word[1])
        word3 = []
        word3.append(word[2])
        word4 = []
        word4.append(word[3])

        #（前端列增加列,需要改）
        listfront1 = [word4,word1,word2,word3]
        listfront2 = listfront1[0:100]

        # 增加SQL（增加SQL,需要改）
        sqltext = []
        # 1
        sqltext.append("select * from v$logfile where type <> 'ONLINE'")
        sqltext.append("select inst_id,sid,event,p1text,p1,p2text,p2,seconds_in_wait,state "
                       "from gv$session_wait where wait_time=0 and  state='WAITING'"
                       "and  event not like 'SQL*Net message%'"
                       "and  event not like 'rdbms ipc message%'"
                       "and  event not like '%mon timer'"
                       "and  event not like 'g%s remote message'"
                       "and  event not like 'job%'"
                       "and  event not like 'PX%'"
                       "and  event not like 'global cache%'"
                       "and  event not like 'db file sequential read%'"
                       "and  event not like 'log file sync%'"
                       "and  event not like 'control file%'"
                       "order by 1")
        sqltext.append("select f.tablespace_name tablespace_name,round((d.sumbytes/1024/1024/1024),2) total_g, round(f.sumbytes/1024/1024/1024,2) free_g, round((d.sumbytes-f.sumbytes)*100/d.sumbytes,2) used_percent from (select tablespace_name,sum(bytes) sumbytes from dba_free_space group by tablespace_name) f, (select tablespace_name,sum(bytes) sumbytes from dba_data_files group by tablespace_name) d  where f.tablespace_name= d.tablespace_name and round((d.sumbytes-f.sumbytes)*100/d.sumbytes,2) > 80 order by 4")
#        sqltext.append("SELECT to_char(ssn.sid, '9999') || ' - ' || nvl(ssn.username, nvl(bgp.name, 'background')) || nvl(lower(ssn.machine), ins.host_name) "SESSION", to_char(prc.spid, '999999999') "PID/THREAD",  to_char((se1.value/1024)/1024, '999G999G990D00') || ' MB' "      CURRENT SIZE",             to_char((se2.value/1024)/1024, '999G999G990D00') || ' MB' "      MAXIMUM SIZE"     FROM     v$sesstat se1, v$sesstat se2, v$session ssn, v$bgprocess bgp, v$process prc,          v$instance ins,  v$statname stat1, v$statname stat2 WHERE    se1.statistic# = stat1.statistic# and stat1.name = 'session pga memory' AND      se2.statistic#  = stat2.statistic# and stat2.name = 'session pga memory max' AND      se1.sid        = ssn.sid AND      se2.sid        = ssn.sid AND      ssn.paddr      = bgp.paddr (+) AND      ssn.paddr      = prc.addr  (+) AND      (se2.value/1024/1024)>100 order by 3")
        sqltext.append("select t.* from v$resource_limit t  where t.resource_name in ('enqueue_locks','processes','sessions') and  decode(trim(t.INITIAL_ALLOCATION),'UNLIMITED',0,to_number(trim(t.INITIAL_ALLOCATION)))-t.MAX_UTILIZATION<100")

        # 6
        sqltext.append("select * from (select count(1) active_num from v$session where status='ACTIVE' and username not in ('SYS','SYSTEM')) t where t.active_num>30")
        sqltext.append("SELECT OWNER,INDEX_NAME,INDEX_TYPE,TABLE_NAME,STATUS FROM DBA_INDEXES  WHERE STATUS = 'UNUSABLE'")
        sqltext.append("select rpad(oracle_username,10) o_name,session_id sid, decode(locked_mode,0,'None',1,'Null',2,'Row share', 3,'Row Exclusive',4,'Share',5,'Share Row Exclusive',6,'Exclusive') lock_type, object_name ,xidusn,xidslot,xidsqn from v$locked_object,all_objects where v$locked_object.object_id=all_objects.object_id")
        sqltext.append("select d.spid,       c.terminal,       c.program,       a.username,       a.opname,       round(a.sofar * 100 / totalwork, 0) || '%' as progress,       a.time_remaining,       b.sql_text,       b.hash_value  from v$session_longops a, v$sql b,v$session c,v$process d where a.time_remaining > 7200  and a.sql_address = b.address   and a.sql_hash_value = b.hash_value   and a.sid=c.sid and c.paddr=d.addr and rownum<30")
        sqltext.append("SELECT se.sid,se.serial#,pr.SPID,se.username,se.status,se.terminal,se.program,se.MODULE,se.sql_address,st.event,st. p1text,si.physical_reads,sq.sql_text,sq.hash_value   FROM v$session se,v$session_wait st,v$sess_io si,v$process pr,v$sqltext sq     WHERE st.sid=se.sid AND     st.sid=si.sid AND se.PADDR=pr.ADDR AND se.program not like 'oracle%' AND st.wait_time=0 AND st.event NOT LIKE '%SQL%' AND se.sql_address=sq.address AND se.sql_hash_value=sq.hash_value    AND si.physical_reads>1000000 and rownum<30 ORDER BY si.physical_reads DESC,sq.piece")

        # 11
        sqltext.append("select sequence_owner,     sequence_name,     min_value,     max_value,     increment_by,     last_number,     cache_size,     cycle_flag  from dba_sequences where max_value-last_number<1000 and CYCLE_FLAG='N'  and max_value <> '-1'")

        # 给最后异常处理使用的list清单,根据查询的SQL数量进行延长,这里统一指向前面的变量
        list2 = listfront1
        for num in sqltext:
            list2.append(['连接异常'])

        # 数据库连接异常处理
        try:
            db1=cx_Oracle.connect(username,pwd,dsn)

            # 获取游标
            cursor = db1.cursor()

            # 前端固定的列更改,这里统一指向前面的变量
            list1 = listfront2
            # 执行查询
            for sqlword in sqltext:
                try:
                    sql = sqlword
                    cursor.execute(sql)
                # 获取数据 ，可以有多种方式 fetchall()，fetchmang(N)(N 为正整数),fetchone()
                    result = cursor.fetchall()
                    count = cursor.rowcount
                # count = cursor.rowcount
                    cursor.close
                except:
                # 这里也是增加双层列表嵌套,方便HTML循环展示
                    result = [['表或视图不存在']]

                # 增加判断,如果行数大于1,结果就往里面再深一层,就是减少多余刘表的字符,如('2015-11-19',) -> 2015-11-19 等
                # 增加异常处理,如果行数取到的值不是数字,就判断为空值
                try:
                    if count >= 2:
                        list1.append(result)
                    else:
                        list1.append(result[0])
                except:
                    list1.append(['None'])

            allresult.append(list1)
        except:
            allresult.append(list2)
    return render_to_response("tablexunhuan.html",locals())
```    
    
#### 视图展示：
templates/tablesunhuan.html

* tablexunhuan.html
实现循环套取列表的数据，并适当进行对齐

第一版，有问题

```
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Oracle DB Check</title>
    </head>
    <body>
        <p>========================================== ==========================================</p>
        <p>Oracle DB Check - test </p>
        <table border="1">
            <tr>
                <th align="left" width="100">
                    系统名称
                </th>
                <th align="left" width="100">
                    系统IP
                </th>
                <th align="left" width="100">
                    端口
                </th>
                <th align="left" width="100">
                    实例
                </th>
                <th align="left" width="100">
                    有效会话数
                </th>
                <th align="left" width="100">
                    DB创建时间
                </th>
                <th align="left" width="100">
                    查询3
                </th>
            </tr>
        </table>
        {% for i in allresult %}
            <table border="1">
                <tr>
                    {% for j in i %}
                        <td align="left" width="100">
                            <nobr>
                                {% for h in j %}
                                    <p>{{h}}</p>
                                {% endfor %}
                            </nobr>
                        </td>
                    {% endfor %}
                </tr>
            </table>
        {% endfor %}
        <p>========================================== ==========================================</p>
    </body>
</html>
```

最终版,能够实现统一对齐的功能

```
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Oracle DB Check</title>
        <style>
        p {
	        color: #1e2e31;
	        text-align:left;
            line-height:12px;
        }

        table,td,th
        {
            border:1px solid black;
        }
        table
        {
            width:180em;

        }
        th
        {
            height:50px;
        }
        </style>
    </head>
    <tr>
        <p>========================================== ==========================================</p>
        <p>Oracle DB Check - test </p>
        <table>
            <tr>
                {% for e in titile %}
                <th>
                    <p>{{e}}</p>
                </th>
                {% endfor %}
            </tr>
            {% for i in allresult %}
            <tr>
                {% for j in i %}
                <td>
                    {% for h in j %}
                    <p>{{h}}</p>
                    {% endfor %}
                </td>
                {% endfor %}
            </tr>
        {% endfor %}
        </table>
        <p>========================================== ==========================================</p>
    </body>
</html>
```

#### 技术点 
实现的技术点，在第三章的功能展示模块里有，
包括异常判断，CSS,HTML的相应功能





### 3 单项查询
跟巡检模块类似，固定好查询内容即可，更简单。


#### 实现过程
1 实现一个页面，里面有相应文字的按钮，点击之后跳转到访问的页面（待实现）

#### 网站入口
urls.py

```
from django.conf.urls import url
from . import view,testdb,search,search2,dbck,dbsearch,searchsql,searchdz
from django.contrib import admin
from django.conf import settings
from django.conf.urls.static import static
from django.contrib.staticfiles.urls import staticfiles_urlpatterns


urlpatterns = [
    url(r'^searchdz?q=1', searchdz.search),
]

urlpatterns += staticfiles_urlpatterns()
```

#### 逻辑实现:searchdz.py


```
# -*- coding: utf-8 -*-
import sys
defaultencoding = 'utf-8'
if sys.getdefaultencoding() != defaultencoding:
    reload(sys)
    sys.setdefaultencoding(defaultencoding)

from django.http import HttpResponse
from django.shortcuts import render_to_response

import cx_Oracle
from django.shortcuts import HttpResponseRedirect,Http404,HttpResponse,render_to_response,render


# 接收请求数据
def search(request):
    request.encoding='utf-8'


    # 账号用户名
    username = "system"
    pwd = "oracle"

    # 定义最终结果集列表
    allresult = []

    # 将需要增加的系统按照列表添加（增加系统,需要改）
    dict = []
    dict.append(('10.37.129.3','1521','imstest','营销生产系统'))
    dict.append(('10.37.129.3','1521','test2','ERP系统'))
    dict.append(('10.37.129.3','1521','imstest','电力交易系统'))
    dict.append(('10.37.129.3','1521','test2','能效管理系统'))

    # 标题名称（增加SQL,需要改）
    titile = []
    titile.append('系统名称')
    titile.append('系统IP')
    titile.append('端口')
    titile.append('实例')

    ## 一下是SQL（增加SQL,需要改）
    titile.append('结果查询')

    for word in dict:
        dsn = cx_Oracle.makedsn(str(word[0]),str(word[1]),str(word[2]))

        # 为了让后续表格的内容都是列表,这是系统名称,IP,端口等信息,统一格式,方便html循环展示成表格
        word1 = []
        word1.append(word[0])
        word2 = []
        word2.append(word[1])
        word3 = []
        word3.append(word[2])
        word4 = []
        word4.append(word[3])

        #（前端列增加列,需要改）
        listfront1 = [word4,word1,word2,word3]
        listfront2 = listfront1[0:100]

        # SQL条件判断
        sqltext = []
        sqlinput = request.GET['q']
        # 1
        if sqlinput == '1':
            sqltext.append("select grantee from DBA_role_privs where granted_role='DBA'")
        elif sqlinput == '2':
            sqltext.append("select round(((((((to_number(to_char(sysdate, 'YYYY')) - 1988) * 12 * 31 * 24 * 60 * 60) + ((to_number(to_char(sysdate, 'MM')) - 1) * 31 * 24 * 60 * 60) + (((to_number(to_char(sysdate, 'DD')) - 1)) * 24 * 60 * 60) + (to_number(to_char(sysdate, 'HH24')) * 60 * 60) + (to_number(to_char(sysdate, 'MI')) * 60) + (to_number(to_char(sysdate, 'SS')))) * (16 * 1024)) - dbms_flashback.get_system_change_number) / (16 * 1024 * 60 * 60 * 24)),2) Headroom from v$instance")
        elif sqlinput == '3':
            sqltext.append("select event, count(1) sum_count from gv$session_wait group by rollup(event) order by sum_count desc")
        elif sqlinput == '4':
            sqltext.append("select profile,resource_name,limit from dba_profiles")
        else:
            sqltext = ["select * from dual"]


        # 给最后异常处理使用的list清单,根据查询的SQL数量进行延长,这里统一指向前面的变量
        list2 = listfront1
        for num in sqltext:
            list2.append(['连接异常'])

        # 数据库连接异常处理
        try:
            db1=cx_Oracle.connect(username,pwd,dsn)

            # 获取游标
            cursor = db1.cursor()

            # 前端固定的列更改,这里统一指向前面的变量
            list1 = listfront2
            # 执行查询
            for sqlword in sqltext:
                try:
                    sql = sqlword
                    cursor.execute(sql)
                # 获取数据 ，可以有多种方式 fetchall()，fetchmang(N)(N 为正整数),fetchone()
                    result = cursor.fetchall()
                    count = cursor.rowcount
                # count = cursor.rowcount
                    cursor.close
                except:
                # 这里也是增加双层列表嵌套,方便HTML循环展示
                    result = [['表或视图不存在']]

                # 增加判断,如果行数大于1,结果就往里面再深一层,就是减少多余刘表的字符,如('2015-11-19',) -> 2015-11-19 等
                # 增加异常处理,如果行数取到的值不是数字,就判断为空值
                try:
                    if count >= 2:
                        list1.append(result)
                    else:
                        list1.append(result[0])
                except:
                    list1.append(['None'])
            allresult.append(list1)
        except:
            allresult.append(list2)

    return render_to_response("dzcx.html",locals())
```

#### 视图展示: dzcx.html

```
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Oracle DB Check</title>
        <link rel="stylesheet" href="/static/css/style.css">
        <link rel="stylesheet" href="/static/css/bootstrap.min.css">
        <style>

        </style>
    </head>
<div class="container">
 <div class="row clearfix">
  <div class="col-md-12 column">
    {% include 'head.html' %}
    {% include 'left1.html' %}

    <div class="col middle-column">
        <div class="article-body">
            <div class="article-intro" id="content">
                <h1>Oracle <span class="color_h1">常见查询</span></h1>
                <hr>
                <p><span class="new" style="float: left">参数</span>&nbsp;: Oracle数据库常用查询。</p>
                <div>
                    <a href="/searchdz?q=1">DBA权限</a>
                    <a href="/searchdz?q=2">SCN记录</a>
                    <a href="/searchdz?q=3">等待事件</a>
                    <a href="/searchdz?q=4">profile</a>
                </div>
                <table class="reference notranslate" id="biaoge1">
                    <tbody>
                    <tr>
                    {% for e in titile %}
                        <th>
                            {{e}}
                        </th>
                    {% endfor %}

                    </tr>
                    {% for i in allresult %}
                    <tr>
                        {% for j in i %}
                        <td>
                            {% for h in j %}
                            <p>{{h}}</p>
                            {% endfor %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
  </div>
 </div>
      {% include 'foot.html' %}
</div>
    </body>
</html>

```


### 4 查询模块：

#### 实现过程
1 实现一个输入框（查询的SQL），按钮，点击后，返回相应的查询页面（实现）
2 增加系统的选择（实现）
3 系统进行分类，比如I6000（实现）
4 统一一个函数，一个页面打开只做一个SQL查询，(实现）
主页进行变量判断
5 变量存入数据库
记录一个清单

#### 网站入口
urls.py

```
...
from . import view,testdb,search,search2,dbck,dbsearch,searchsql
...

urlpatterns = [
    url(r'^searchsql', searchsql.search),
]

urlpatterns += staticfiles_urlpatterns()
```

#### 逻辑实现:searchsql.py


```
# -*- coding: utf-8 -*-
import sys
defaultencoding = 'utf-8'
if sys.getdefaultencoding() != defaultencoding:
    reload(sys)
    sys.setdefaultencoding(defaultencoding)

from django.http import HttpResponse
from django.shortcuts import render_to_response

import cx_Oracle
from django.shortcuts import HttpResponseRedirect,Http404,HttpResponse,render_to_response,render


def search(request):
    request.encoding='utf-8'


    # 账号用户名
    username = "system"
    pwd = "oracle"

    # 定义最终结果集列表
    allresult = []

    # 将需要增加的系统按照列表添加（增加系统,需要改）
    dict = []
    dict.append(('10.37.129.3','1521','imstest','营销生产系统'))
    dict.append(('10.37.129.3','1521','test2','ERP系统'))
    dict.append(('10.37.129.3','1521','imstest','电力交易系统'))
    dict.append(('10.37.129.3','1521','test2','能效管理系统'))

    # 标题名称（增加SQL,需要改）
    titile = []
    titile.append('系统名称')
    titile.append('系统IP')
    titile.append('端口')
    titile.append('实例')

    ## 一下是SQL（增加SQL,需要改）
    titile.append('结果查询')

    for word in dict:
        dsn = cx_Oracle.makedsn(str(word[0]),str(word[1]),str(word[2]))

        # 为了让后续表格的内容都是列表,这是系统名称,IP,端口等信息,统一格式,方便html循环展示成表格
        word1 = []
        word1.append(word[0])
        word2 = []
        word2.append(word[1])
        word3 = []
        word3.append(word[2])
        word4 = []
        word4.append(word[3])

        #（前端列增加列,需要改）
        listfront1 = [word4,word1,word2,word3]
        listfront2 = listfront1[0:100]

        # 获取页面dzcxsql.html传来的Q的值
        sqltext = []
        sqlinput = request.GET['q']

        sqltext.append(sqlinput)

        # 给最后异常处理使用的list清单,根据查询的SQL数量进行延长,这里统一指向前面的变量
        list2 = listfront1
        for num in sqltext:
            list2.append(['连接异常'])

        # 数据库连接异常处理
        try:
            db1=cx_Oracle.connect(username,pwd,dsn)

            # 获取游标
            cursor = db1.cursor()

            # 前端固定的列更改,这里统一指向前面的变量
            list1 = listfront2
            # 执行查询
            for sqlword in sqltext:
                try:
                    sql = sqlword
                    cursor.execute(sql)
                # 获取数据 ，可以有多种方式 fetchall()，fetchmang(N)(N 为正整数),fetchone()
                    result = cursor.fetchall()
                    count = cursor.rowcount
                # count = cursor.rowcount
                    cursor.close
                except:
                # 这里也是增加双层列表嵌套,方便HTML循环展示
                    result = [['表或视图不存在']]

                # 增加判断,如果行数大于1,结果就往里面再深一层,就是减少多余刘表的字符,如('2015-11-19',) -> 2015-11-19 等
                # 增加异常处理,如果行数取到的值不是数字,就判断为空值
                try:
                    if count >= 2:
                        list1.append(result)
                    else:
                        list1.append(result[0])
                except:
                    list1.append(['None'])
            allresult.append(list1)
        except:
            allresult.append(list2)

    return render_to_response("dzcxsql.html",locals())
```

#### 视图展示: dzcxsql.html

```
...
<div class="container">
 <div class="row clearfix">
  <div class="col-md-12 column">
    {% include 'head.html' %}
    {% include 'left1.html' %}

    <div class="col middle-column">
        <div class="article-body" >
            <div class="article-intro" id="content">
                <h1>Oracle <span class="color_h1">自定义查询</span></h1>
                <p><span class="new" style="float: left">参数</span>&nbsp;: 自定义查询</p>
                <div>
                    <form action="/searchsql?q" method="get">
                        <input type="text" name="q">
                        <input type="submit" value="搜索">
                </div>

                <table class="reference notranslate" id="biaoge1">
                    <tbody>
                    <tr>
                    {% for e in titile %}
                        <th>
                            {{e}}
                        </th>
                    {% endfor %}

                    </tr>
                    {% for i in allresult %}
                    <tr>
                        {% for j in i %}
                        <td>
                            {% for h in j %}
                            <p>{{h}}</p>
                            {% endfor %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
  </div>
 </div>
      {% include 'foot.html' %}
</div>
    </body>
</html>

```


#### 技术点


### 5 监控模块：
定制一张巡检页面，定义好已设置的查询，反馈HTML结果


### 6 台账管理
#### 实现步骤
1 数据库建立（实现）
2 函数能够查询、插入、更新、删除
3 跟网页交互，能够调用函数，并展示
[参考](http://blog.csdn.net/zhubaojay/article/details/64128769)

### 7 页面布局

#### 整体布局

* 主页
container


```
<div class="container">
 <div class="row clearfix">
  <div class="col-md-12 column">
   {% include 'head.html' %}

   <div class="row">
    <div class="col-md-4">
     <div class="thumbnail">
      <img alt="XXX" src="/static/images/begin.jpg">
      <div class="caption">
       <h3> 告警 </h3>
       <p> 自动化运维,工作,自我学习使用</p>
       <p> <a class="btn btn-success" href="/1">自留地,暂定 &gt;&gt;</a>
           <a class="btn btn-default" href="/1">暂定</a>
           <a class="btn btn-danger" href="/2" title="Python 学习资源">暂定</a>
       </p>
       <div class="row clearfix">
        <div class="col-xs-6 column">
         <ul class="list-unstyled">
             <li><a href="/1">暂定</a></li>
         </ul>
        </div>
       </div>
      </div>
     </div>
    </div>
    <div class="col-md-4">
     <div class="thumbnail">
      <img alt="在线实例" src="/static/images/online-try.jpg">
      <div class="caption">
       <h3> 标题3 </h3>
       <p>待定 </p>
       <p><a class="btn btn-primary" href="/try/tryjs_lightbulb/">待定 &gt;&gt;</a></p>
       <div class="row clearfix">
        <div class="col-xs-6 column">
         <ul class="list-unstyled">
             <li><a href="/1">暂定1</a></li>
         </ul>
        </div>
        <div class="col-xs-6 column">
         <ul class="list-unstyled">
             <li><a href="/1">待定2</a></li>
         </ul>
        </div>
       </div>
      </div>
     </div>
    </div>
    <div class="col-md-4">
     <div class="thumbnail">
      <img alt="标题3" src="/static/images/references.jpg">
      <div class="caption">
       <h3> 标题3 </h3>
       <p>标题内容 </p>
       <p> <a class="btn btn-warning" href="/3">待定</a> </p>
       <div class="row clearfix">
        <div class="col-xs-6 column">
         <ul class="list-unstyled">
             <li><a href="/1">暂定1</a></li>
         </ul>
        </div>
        <div class="col-xs-6 column">
         <ul class="list-unstyled">
         </ul>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
 </div>
 <div class="row clearfix">
  <div class="col-md-12">
   <div class="row">
    
    <div class="col-lg-3 col-md-4 col-sm-6">
   </div>
  </div>
 </div>

 {% include 'foot.html' %}

</div>
```

* head.html 
   <div class="page-header">
   </div>
   
   <nav class="navbar navbar-default" role="navigation">
    
    <div class="navbar-header">
    
    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
    
     <div class="navbar-form navbar-right">
     </div>
    </div>
   </nav>

       
* 查看边框

添加
 style="border-style:solid;border-width:1px;border-color:#5588a1;"
 
* 表格可以根据页面自动调整 
div增加                <table class="reference notranslate" id="biaoge1">
style.css增加 

```

@media screen and (min-width:100px){
	#biaoge1{
		width:100%;
	}
}

@media screen and (min-width:1100px){
	#biaoge1{
		width:127%;
	}
}

```

bootstrap.min.css


@media (min-width:769px) {
	.container {
	width:750px
}
}@media (min-width:992px) {
	.container {
	width:970px
}
}@media (min-width:1200px) {
	.container {
	width:1170px
}

* 经常自动表格缩减一段
删除以下表格变小不能自己缩小，将1024改为3600即可。
@media handheld,only screen and (max-width:1024px) {
	.right-column {
	display:none
}



#### CSS修改
第二个container   改为 container_delete，防止误用

* 整体位置左移跟油移
修改
bootstrap.min.css
margin-left:auto > 10px
```
.container {
	padding-right:15px;
	padding-left:15px;
	margin-right:auto;
	margin-left:10px
}
```

* 删除右边宽度限制，删除下边class的row即可
 <div class="row clearfix">



#### head


#### left
采用的CSS style.css
#### middle 
采用的CSS style.css
宽度：
表格格式：


#### right

#### foot

#### 颜色替换
style.css
绿色转蓝色

```
new，背景
#90b575 > #8fb5c6

#64854c > #5588a1
```

#### 表格
行间距
line-height
reference notranslate

style.css增加如下

table.reference p {
	line-height:1em
}
#### 其他功能

* 表单风格变化
style.css设置
input[type=submit]

input[type=text] {
    border: 1px solid #ccc;
    padding: 2px;
    font-size: 1.2em;
    color: #325d6b;
    width: 20em;
}


### 7 后台管理模块

#### 数据库后台管理

* 添加数据
* 

## 四、相应功能模块

### 1 页面展示方面

[参考网站-Django模板进阶](http://code.ziqiangxuetang.com/django/django-template2.html)
[参考网站-BUNOOB CSS表格](http://www.runoob.com/css/css-table.html)

宽度设置浮动


#### CSS

[CSS代码格式化工具](http://tool.lanrentuku.com/cssformat/)
[html梅花工具](http://tool.lu/html/)

能不能实现循环的表格自定义的大小

* 内嵌

```
<head>
<style>
hr {color:sienna;}
p {margin-left:20px;}
body {background-image:url("images/back40.gif");}
</style>
</head>
```
* 折叠边，就是只有一条线

```
table {
    border-collapse: collapse;
}

table, td, th {
    border: 1px solid black;
}
```



* 左边栏，随着点击，形成不同的背景
.leftcolumn a{
	background-color: #8fb5c6;
	font-weight: bold;
	color: rgb(255, 255, 255)
}

* django配置CSS文件
[参考官方文档](https://docs.djangoproject.com/en/1.11/howto/static-files/)
1 建立根目录底下static文件
这个文件后续放CSS,JPG等文件

```
mkdir static
cd static
mkdir css
vi stype.css

html{overflow-y:scroll;}

body,p,h1,h2,h3,h4,table,td,th,ul,ol,textarea,input
{
font-size:12px;font-family:microsoft yahei;color: #111;
}
table,th,td,input,textarea
{
font-size:100%;
}
h1 {font-size:190%;margin-top:0px;font-weight:normal;color:darkslategray}
h2 {font-size:160%;margin-top:10px;margin-bottom:10px;font-weight:normal}
h3 {font-size:120%;font-weight:normal}
h4 {font-size:100%;}
h5 {font-size:90%;}
h6 {font-size:80%;}
```


2 urls配置
添加

```
from django.contrib.staticfiles.urls import staticfiles_urlpatterns
urlpatterns = [
    url(r'^zqxt', view.ckfirst),
]
    
# 底下删了，不影响
urlpatterns += staticfiles_urlpatterns()
```    

4 setting.py
添加

```
# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/1.11/howto/static-files/

STATIC_URL = '/static/'
STATIC_ROOT = ''

STATICFILES_DIRS = [
    os.path.join(BASE_DIR, "static"),
]

```

5 view.py

```
def zqxt(request):
    return render(request,'zqxt.html')
```

6 网页链接,zqxt.html
添加

```
    <title>这是测试标题,CSS</title>
    <link rel="stylesheet" type="text/css" href="/static/css/style.css"/>
```

select grantee from DBA_role_privs where granted_role='DBA';    

#### html

* 展示表格

```
        <table border="1">
            <tr>
                <td>{{i}}</td>
            </tr>
        </table>
```

* 表格对齐

```
<table>
    <tr>
        <th>Firstname</th>
        <th>Lastname</th>
        <th>Savings</th>
    </tr>
    <tr>
        <td>Peter</td>
        <td>Griffin</td>
        <td>$100</td>
    </tr>
    <tr>
        <td>Lois</td>
        <td>Griffin</td>
        <td>$150</td>
    </tr>
</table>
```




#### 一些功能

* 鼠标放到系统名称，提示相应信息（html-title）（待实现）
* 设置HEAD，FOOT段落
* 增加左边快捷导航
* 宽度根据实际情况扩张
 
### 2 异常判断

#### 1 表不存在（实现）

```
try:
    sql = sqlword
    cursor.execute(sql)
# 获取数据 ，可以有多种方式 fetchall()，fetchmang(N)(N 为正整数),fetchone()
    result = cursor.fetchall()
    count = cursor.rowcount
# count = cursor.rowcount
    cursor.close
except:
# 这里也是增加双层列表嵌套,方便HTML循环展示
    result = [['表或视图不存在']]
```

#### 2 监听或者数据库连接异常（实现） 

```
try:
    内容为查询数据库，省略....

    allresult.append(list1)
except:
    allresult.append(list2)
```

#### 3 获取空值判断，自动判断结果对象（实现）
不要有多余的字符，也能够显示全部的信息

判断结果是否多行，如果是，那么取结果的值得列表第一位
由于可能存在SQL取到的值是空值，需要进行异常判断

count =cursor.rowcount
再进行count判断

```
    # 这是行数，可能存在1，多行，或者空值
    count = cursor.rowcount
try:
    if count >= 2:
        list1.append(result)
    else:
        list1.append(result[0])
except:
    list1.append(['None'])
```

4 判断传输的SQL
去掉回车键



### 3 转换EXCEL
    * 获取到的数据，让入excel文件
    
### 4 完善展示的页面


### 5 元数据的存取
    这是将数据信息统一放入数据库

#### 涉及的表
系统数据库
系统名称、系统IP、端口、实例名称、是否I6000监控、是否运维移交
sysname,sysip,port,instance,i6000,manager

名称表


#### Django使用Mysql
##### 1 安装Mysql
版本5.7

##### 2 客户端配置
pip install MysqL-python
pip install mysqlclient

##### 3 创建监控的数据库
create database zdyw default charset=utf8;

##### 4 创建用户
 CREATE USER zdywuser@localhost IDENTIFIED BY 'zdywuser123';

 grant all on mysql.* to zdywuser@localhost;
 grant all on zdyw.* to zdywuser@localhost;
 flush privileges;
  
flush privileges;
grant all privileges on *.* to 'zdywuser'@'%' identified by 'zdywuser123' with grant option;
 
##### 5 数据库配置
setting.py

```
# Database
# https://docs.djangoproject.com/en/1.11/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',  # 或者使用 mysql.connector.django
        'NAME': 'zdyw',        # database name
        'USER': 'zdywuser',
        'PASSWORD': 'zdywuser123',
        'HOST':'10.211.55.7',
        'PORT':'3306',
    }
}


DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',  # 或者使用 mysql.connector.django
        'NAME': 'mysql',
        'USER': 'guest',
        'PASSWORD': 'guest123',
        'HOST':'10.211.55.7',
        'PORT':'3306',
    }
}
```

##### 6 定义模型
创建APP
django-admin.py startapp zdywmodel

接下来在settings.py中找到INSTALLED_APPS这一项，如下：

```
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'zdywmodel',               # 添加此项

]
```

##### 6 添加数据表
models.py 添加数据库

| ID | sysname | sysip | port | instance | i6000 | manager | people1 | iphonenumber1 | people2 | iphonenumber1 | people3 | iphonenumber1 | other|
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 序列号 | 系统名称 | 系统IP | 端口 | 实例名称 | 是否i6000监控 | 是否运维移交 | 联系人1 | 电话1 | 联系人2 | 电话2 | 联系人3 | 电话3 |  其他 | 

```
# models.py
# -*- coding: utf-8 -*-
from __future__ import unicode_literals

from django.db import models

# Create your models here.
class Oracle(models.Model):
    number = models.IntegerField(blank=True,null=True)
    sysname = models.CharField(max_length=20)
    sysip = models.CharField(max_length=20)
    port = models.CharField(max_length=6)
    instance = models.CharField(max_length=15)
    i6000 = models.CharField(max_length=4,blank=True,null=True)
    manager = models.CharField(max_length=4,blank=True,null=True)
    people1 = models.CharField(max_length=20,blank=True,null=True)
    iphonenumber1 = models.CharField(max_length=15,blank=True,null=True)
    people2 = models.CharField(max_length=20,blank=True,null=True)
    iphonenumber2 = models.CharField(max_length=15,blank=True,null=True)
    people3 = models.CharField(max_length=20,blank=True,null=True)
    iphonenumber3 = models.CharField(max_length=15,blank=True,null=True)
    other = models.CharField(max_length=50,blank=True,null=True)

class titile(models.Model):
    number = models.IntegerField(blank=True,null=True)
    name   = models.CharField(max_length=20) 
```

以上的类名代表了数据库表名，且继承了models.Model，类里面的字段代表数据表中的字段(name)，数据类型则由CharField（相当于varchar）、DateField（相当于datetime）， max_length 参数限定长度。


利用Djang创建表

```
$ python3 manage.py migrate   # 创建表结构

$ python3 manage.py makemigrations zdywmodel  # 让 Django 知道我们在我们的模型有一些变更
$ python3 manage.py migrate zdywmodel   # 创建表结构
```

执行以上以后，创建了一些表，


```
mysql> show tables;
+----------------------------+
| Tables_in_zdyw             |
+----------------------------+
| auth_group                 |
| auth_group_permissions     |
| auth_permission            |
| auth_user                  |
| auth_user_groups           |
| auth_user_user_permissions |
| django_admin_log           |
| django_content_type        |
| django_migrations          |
| django_session             |
| zdywmodel_oracle           |
| zdywmodel_titile           |
+----------------------------+
12 rows in set (0.00 sec)
```
  注意：尽管我们没有在models给表设置主键，但是Django会自动添加一个id作为主键。

  
drop table auth_user_user_permissions;
drop table auth_user_permissions; 
drop table auth_user_groups;
drop table auth_group   ;          
drop table auth_group_permissions ;
drop table auth_permission        ;
drop table auth_user             ; 
drop table django_admin_log     ;  
drop table django_content_type ;   
drop table django_migrations  ;    
drop table django_session    ;     

#### Django操作Mysql数据

1 urls添加
from . import view,testdb
 
urlpatterns = [
    url(r'^hello$', view.hello),
    url(r'^testdb$', testdb.testdb),
]

2 编写py文件
testdb.py

    number = models.IntegerField(max_length=10)
    sysname = models.CharField(max_length=20)
    sysip = models.CharField(max_length=20)
    port = models.CharField(max_length=6)
    instance = models.CharField(max_length=15)
    i6000 = models.CharField(max_length=4)
    manager = models.CharField(max_length=4)
    people1 = models.CharField(max_length=20)
    iphonenumber1 = models.CharField(max_length=15)
    people2 = models.CharField(max_length=20)
    iphonenumber2 = models.CharField(max_length=15)
    people3 = models.CharField(max_length=20)
    iphonenumber3 = models.CharField(max_length=15)
    other = models.CharField(max_length=50)

##### 1 添加数据

>>> from zdywmodel.models import titile
>>> titile.objects.create(name="系统名称")
>>> titile.objects.create(name="系统IP")
>>> titile.objects.create(name="端口")
>>> titile.objects.create(name="实例")

其他方法

```
1 Person.objects.create(name=name,age=age)

2 p = Person(name="WZ", age=23)
p.save()

3 p = Person(name="TWZ")
p.age = 23
p.save()

4 Person.objects.get_or_create(name="WZT", age=23)

这种方法是防止重复很好的方法，但是速度要相对慢些，返回一个元组，第一个为Person对象，第二个为True或False, 新建时返回的是True, 已经存在时返回False.
```

##### 2 获取数据

titile.objects.filter(id=1)
返回查询集
<QuerySet [<titile: titile object>]>

titile.objects.get(id='1')
<titile: titile object>

titile.objects.get(id='1')

```
titile.objects.all()
返回的是Queryset对象，bing没有真的获取到

Person.objects.all()[:10] 切片操作，获取10个人，不支持负索引，切片可以节约内存

Person.objects.get(name=name)

```

完成Py程序,页面展示

```
# -*- coding: utf-8 -*-
 
from django.http import HttpResponse
 
from zdywmodel.models import titile
 
# 数据库操作
def testdb(request):
    # 初始化
    response = ""
    response1 = ""
    
    
    # 通过objects这个模型管理器的all()获得所有数据行，相当于SQL中的SELECT * FROM
    list = titile.objects.all()
        
    # filter相当于SQL中的WHERE，可设置条件过滤结果
    response2 = titile.objects.filter(id=1)
    
    # 获取单个对象
    response3 = titile.objects.get(id=1)
    
    # 限制返回的数据 相当于 SQL 中的 OFFSET 0 LIMIT 2;
    titile.objects.order_by('name')[0:2]
    
    #数据排序
    titile.objects.order_by("id")
    
    # 上面的方法可以连锁使用
    titile.objects.filter(name="runoob").order_by("id")
    
    # 输出所有数据
    for var in list:
        response1 += var.name + " "
    response = response1
    return HttpResponse("<p>" + response + "</p>")
```




python直接引用

```
# -*- coding: utf-8 -*-

import os,django

# Hellolzx 项目名称，也就是直接试用DJANGO中Hellolzx项目的环境变量
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "Hellolzx.settings")

django.setup()

from django.http import HttpResponse
from zdywmodel.models import titile

print(titile.objects.get(id='1'))
```

##### 3 更新数据

testdb.py编写

```
# -*- coding: utf-8 -*-
 
from django.http import HttpResponse
 
from TestModel.models import Test
 
# 数据库操作
def testdb(request):
    # 修改其中一个id=1的name字段，再save，相当于SQL中的UPDATE
    test1 = Test.objects.get(id=1)
    test1.name = 'Google'
    test1.save()
    
    # 另外一种方式
    #Test.objects.filter(id=1).update(name='Google')
    
    # 修改所有的列
    # Test.objects.all().update(name='Google')
    
    return HttpResponse("<p>修改成功</p>")
```

##### 4 删除数据
select * from zdywmodel_titile;


#### 其他操作

##### 删除APP

1 配置中删除应用
settings.py > installed_apps里删除
删除    'TestModel',

2 urls.py删除
删除以下的testdb相关信息

```
from django.conf.urls import url
from . import view,testdb,search,search2,dbck

urlpatterns = [
    url(r'^hello$', view.hello),
    url(r'^testdb$', testdb.testdb),
```


##### mysql常用操作


```
启动
service mysqld start

连接用户名为root的数据库
mysql -u root -p
root1234

显示数据库
show databases

创建一个Bookdb数据库并设置utf-8编码

create database Bookdb default character set utf8 collate utf8_general_ci;

使用Bookdb数据库
use Bookdb;

显示数据库里的存在的项目名
show tables;

查询books_publisher数据库里的数据
select * from books_publisher;
```



### 6 连接Oracle数据库（实现）

#### 1 Oracle数据库连接

* 连接字符串

```
connection = cx_Oracle.connect("scott", "tiger", "10.37.129.3/imstest")
db1=cx_Oracle.connect('scott','tiger','10.37.129.3:1521/imstest')
db2=cx_Oracle.connect('yang/yang@127.0.0.1:1523/yangdb')
dsn=cx_Oracle.makedsn('10.37.129.3','1523','imstest')
```

连接的代码

```
# -*- coding: utf-8 -*

import cx_Oracle
username = "scott"
pwd = "tiger"
ip = "10.37.129.3"
sid = 'imstest'
dsn=cx_Oracle.makedsn(ip,'1521',sid)

db1=cx_Oracle.connect(username,pwd,dsn)

# 获取游标
cursor = db1.cursor() 
# 执行查询
sql = "select * from dept"
# sql = "host "

cursor.execute(sql)
# 获取数据 ，可以有多种方式 fetchall()，fetchmang(N)(N 为正整数),fetchone()
result = cursor.fetchall() 
count = cursor.rowcount 
print("=====================")
print("IP is",ip,",","ORACLE_SID is",sid )
print("Total:", count )
print("=====================")
for row in result: 
        print(row )
cursor.close
# db1.close()
```

参考

```
import cx_Oracle                                          #引用模块cx_Oracle
conn=cx_Oracle.connect('scott/tiger@10.37.129.3/imstest')    #连接数据库
c=conn.cursor()                                           #获取cursor
x=c.execute('select sysdate from dual')                   #使用cursor进行各种操作
x.fetchone()
c.close()                                                 #关闭cursor
conn.close()                                              #关闭连接
```


### 7 表单交互


正常表单实现方式

* GET

1 编写函数文件
vi search.py，能够提供

实现的功能
点击不同的表单，实现不同的查询内容；

1 实现





## 五、问题
### 1 连接CX_ORACLE包裹
cx_Oracle.DatabaseError: ORA-24454: client host name is not set

连接字符串如下：

```
db1=cx_Oracle.connect('scott','tiger','10.37.129.3:1521/imstest')
db2=cx_Oracle.connect('scott/tiger@oracle112g:1521/imstest')
```

**解决：**
添加本地主机HOST到/etc/hosts
10.211.55.7	    lamp

### 2 pycharm获取不到环境变量
报错

```
cx_Oracle.DatabaseError: DPI-1047: 64-bit Oracle Client library cannot be loaded: "libclntsh.so: cannot open shared object file: No such file or directory". See https://oracle.github.io/odpi/doc/installation.html#linux for help
```

**解决：**
vi /root/.bashrc添加以下内容
LD_LIBRARY_PATH=/usr/lib/oracle/12.2/client64/lib
export LD_LIBRARY_PATH
或
export LD_LIBRARY_PATH=/usr/lib/oracle/12.2/client64/lib:$LD_LIBRARY_PATH

### 3 执行db1.close()时候报错


```
Traceback (most recent call last):
  File "/opt/pyProgram/HelloPython/01 test01.py", line 27, in <module>
    db1.close()
cx_Oracle.DatabaseError: DPI-1054: connection cannot be closed when open statements or LOBs exist
```

    **解答：**

这是阻关闭打开的SQL，目的防止程序崩溃，那么删除db1.close()就好
[参考网站，搜索DPI-1054](http://cx-oracle.readthedocs.io/en/latest/releasenotes.html)


### 4 出现问题，如果跳过去
比如查到如下表不存在：

```
Exception Value:	
ORA-00942: table or view does not exist
```

```
        try:
            sql = "select * from scott.dept"
            cursor.execute(sql)
            result3 = cursor.fetchall()
            cursor.close
        except:
            result3 = 'hello kitty'
```

### 5 字符串转变量

[参考网站-Python：如何将字符串作为变量名](http://blog.csdn.net/ztf312/article/details/51122027)

使用locals()即可

```
num = 0
for i in (1,2,3):
    num = num + 1
    dsn = str('tnsdict')+str(num)
    dsnt = locals()[dsn]
    print(dsnt)
```

### 6 数据库关机状态，异常处理


```
ORA-12505: TNS:listener does not currently know of SID given in connect descriptor
```


```
try:
            db1=cx_Oracle.connect(username,pwd,dsn)
            
    ... # 其他代码都放在这底下            

except:
            list = (word4,word1,word2,word3,['连接异常'])
            allresult.append(list)
```

### 7 变量是指针
id(变量)  查看内存的位置

做一个转化即可

```
listfront1 = [word4,word1,word2,word3]
listfront2 = listfront1[0:100]
```
### 8 复杂SQL，特殊字符如何转义



### 9 查看本地安装库的内容

本地执行

```
[oracle@weblogic ~]$ python -m pydoc -p 1234
pydoc server ready at http://localhost:1234/
```
打开页面，如果客户端访问，可以输入IP地址，如下
`http://10.37.129.3:1234/`
`http://10.211.55.7:1234/`


### 10 django创建数据库报错

执行命令，创建表的时候，报错
python3 manage.py migrate

django.db.utils.OperationalError: (1060, "Duplicate column name 'ID'")

由于第一次执行，就会在应用底下生成PY脚本，后续每一次都会执行这个脚本，所以在models.py修改，也照样报错
cd /opt/pyProgram/Hellolzx/zdywmodel/migrations
[root@lamp migrations]# ls -alt
total 36
drwxr-xr-x 2 root root 4096 Oct 18 14:29 __pycache__
drwxr-xr-x 3 root root 4096 Oct 18 14:28 .
-rw-r--r-- 1 root root 1698 Oct 18 14:28 0003_oracle_titile.py
drwxr-xr-x 4 root root 4096 Oct 18 14:11 ..
-rw-r--r-- 1 root root  707 Oct 18 14:10 0002_auto_20171018_0609.pyc
-rw-r--r-- 1 root root  421 Oct 18 14:09 0002_auto_20171018_0609.py
-rw-r--r-- 1 root root 1463 Oct 18 11:01 0001_initial.pyc
-rw-r--r-- 1 root root 1631 Oct 18 10:37 0001_initial.py
-rw-r--r-- 1 root root  143 Oct 18 10:37 __init__.pyc
-rw-r--r-- 1 root root    0 Oct 17 21:29 __init__.py

每次，依次执行0001.initial.py
more 0001_initial.py
...
    operations = [
        migrations.CreateModel(
            name='Oracle',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, ser
ialize=False, verbose_name='ID')),
                ('ID', models.IntegerField()),
...

删除以上，

注意：ID是默认创建的，不能使用


